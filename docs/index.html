<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Share Live Location (Consent-Based)</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    :root {
      --brand: #4169e1;
      --bg: #f7f9fc;
      --text: #202124;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 24px; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg); color: var(--text);
    }
    .card {
      max-width: 900px; margin: 0 auto; background: #fff; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.06);
      overflow: hidden; border: 1px solid #e9eef5;
    }
    header { padding: 20px 24px; border-bottom: 1px solid #eef2f7; display: flex; align-items: center; gap: 12px; }
    header .dot { width: 10px; height: 10px; border-radius: 999px; background: var(--brand); box-shadow: 0 0 0 6px rgba(65,105,225,0.12); }
    h1 { font-size: 20px; margin: 0; }
    .content { padding: 20px 24px; }
    .row { display: grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 900px) { .row { grid-template-columns: 360px 1fr; } }
    .panel { background: #fbfdff; border: 1px solid #eef2f7; border-radius: 12px; padding: 16px; }
    .muted { color: #5f6368; font-size: 14px; }
    button {
      display: inline-flex; align-items: center; gap: 8px; cursor: pointer; border: 0; border-radius: 12px;
      padding: 12px 16px; background: var(--brand); color: #fff; font-weight: 600; box-shadow: 0 8px 20px rgba(65,105,225,0.25);
    }
    button.secondary { background: #e9eefb; color: #1742d1; box-shadow: none; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    #map { width: 100%; height: 460px; border-radius: 12px; border: 1px solid #eef2f7; }
    .kv { display: grid; grid-template-columns: 140px 1fr; gap: 8px; font-size: 14px; }
    .log { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background: #0b1220; color: #d9e1ff; border-radius: 10px; padding: 12px; height: 160px; overflow: auto; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; border: 1px solid #e0e7ff; background: #f3f5ff; color: #2436a0; }
    .success { color: #0b8f2a; }
    .error { color: #c62828; }
  </style>
</head>
<body>
  <div class="card">
    <header>
      <div class="dot" aria-hidden="true"></div>
      <h1>Share Live Location (with your permission)</h1>
    </header>

    <div class="content">
      <div class="row">
        <!-- Controls / Status Panel -->
        <section class="panel">
          <p class="muted">
            This page will request your browser's location permission. If you allow, it will stream your location
            <span class="pill">live</span> while this tab stays open. You can stop at any time.
          </p>

          <div style="display:flex; gap:8px; flex-wrap: wrap; margin: 12px 0 16px;">
            <button id="startBtn">Start Live Tracking</button>
            <button id="stopBtn" class="secondary" disabled>Stop</button>
            <button id="retryBtn" class="secondary" style="display:none;">Retry</button>
          </div>

          <div class="kv" style="margin-bottom: 12px;">
            <div>Status</div>
            <div id="status">Idle</div>
            <div>Accuracy</div>
            <div id="accuracy">—</div>
            <div>Coordinates</div>
            <div id="coords">—</div>
            <div>Speed</div>
            <div id="speed">—</div>
          </div>

          <details>
            <summary>Advanced (send to server)</summary>
            <p class="muted">Optionally post each update to your backend. Edit <code>ENDPOINT_URL</code> in the source.</p>
            <div class="log" id="log"></div>
          </details>
        </section>

        <!-- Map Panel -->
        <section class="panel">
          <div id="map" role="region" aria-label="Live location map"></div>
        </section>
      </div>

      <p class="muted" style="margin-top: 16px;">
        Tip: If you denied permission earlier, open your browser's <b>Site Settings → Location</b>, allow it, then click <b>Retry</b>.
      </p>
    </div>
  </div>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <script>
    // ======= Configuration =======
    // Set this to your backend endpoint to receive updates, or leave blank to disable sending.
    const ENDPOINT_URL = ""; // e.g., "https://yourserver.com/save-location"

    // ======= State =======
    let map, marker, pathLine, watchId = null;
    let positions = [];

    // ======= UI Helpers =======
    const $ = (id) => document.getElementById(id);
    const statusEl = $("status"), coordsEl = $("coords"), accEl = $("accuracy"), speedEl = $("speed"), logEl = $("log");
    const startBtn = $("startBtn"), stopBtn = $("stopBtn"), retryBtn = $("retryBtn");

    function setStatus(text, cls = "") {
      statusEl.textContent = text;
      statusEl.className = cls;
    }
    function log(msg) {
      const line = `[${new Date().toLocaleTimeString()}] ${msg}\n`;
      logEl.textContent += line;
      logEl.scrollTop = logEl.scrollHeight;
    }

    // ======= Map Setup =======
    function ensureMap(lat = 20.5937, lon = 78.9629, zoom = 5) { // defaults to India view
      if (map) return;
      map = L.map('map').setView([lat, lon], zoom);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);
      pathLine = L.polyline([], { weight: 5, opacity: 0.8 }).addTo(map);
    }

    // ======= Geolocation Logic =======
    function startTracking() {
      if (!('geolocation' in navigator)) {
        setStatus('Geolocation not supported on this device', 'error');
        return;
      }
      startBtn.disabled = true; stopBtn.disabled = false; retryBtn.style.display = 'none';
      setStatus('Requesting permission…');
      watchId = navigator.geolocation.watchPosition(onPosition, onError, {
        enableHighAccuracy: true,
        maximumAge: 0,
        timeout: 10000
      });
    }

    function stopTracking() {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
      setStatus('Stopped');
      startBtn.disabled = false; stopBtn.disabled = true;
    }

    async function onPosition(pos) {
      const { latitude, longitude, accuracy, speed, heading, altitude } = pos.coords;
      const ts = pos.timestamp;

      // Update UI
      setStatus('Live tracking', 'success');
      coordsEl.textContent = `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
      accEl.textContent = accuracy ? `${Math.round(accuracy)} m` : '—';
      speedEl.textContent = (typeof speed === 'number' && !Number.isNaN(speed)) ? `${speed.toFixed(1)} m/s` : '—';

      // Map updates
      ensureMap(latitude, longitude, 16);
      if (!marker) {
        marker = L.marker([latitude, longitude]).addTo(map);
      } else {
        marker.setLatLng([latitude, longitude]);
      }
      positions.push([latitude, longitude]);
      pathLine.setLatLngs(positions);
      map.panTo([latitude, longitude]);

      // Optional: send to backend
      if (ENDPOINT_URL) {
        try {
          const payload = { latitude, longitude, accuracy, speed, heading, altitude, timestamp: ts };
          const res = await fetch(ENDPOINT_URL, {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
          });
          log(`POST ${ENDPOINT_URL} → ${res.status}`);
        } catch (e) {
          log(`POST failed: ${e.message}`);
        }
      }
    }

    function onError(err) {
      stopTracking();
      let msg = '';
      switch (err.code) {
        case err.PERMISSION_DENIED:
          msg = 'You denied location access. Allow it in browser Site Settings → Location, then click Retry.'; break;
        case err.POSITION_UNAVAILABLE:
          msg = 'Location unavailable. Ensure GPS/location is ON and try again.'; break;
        case err.TIMEOUT:
          msg = 'Request timed out. Move to open area or check network, then Retry.'; break;
        default:
          msg = 'Unknown error. Please Retry.';
      }
      setStatus(msg, 'error');
      retryBtn.style.display = 'inline-flex';
    }

    // ======= Wire up UI =======
    startBtn.addEventListener('click', startTracking);
    stopBtn.addEventListener('click', stopTracking);
    retryBtn.addEventListener('click', () => { retryBtn.style.display = 'none'; startTracking(); });

    // Initialize map at country view
    ensureMap();
  </script>
</body>
</html>
